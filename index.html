<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Todo List</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Advanced Todo List</h1>
        
        <div class="list-container">
            <div id="todo-list" class="dropzone">
                <div class="box-title">任务初建</div>
                <ul id="todo-tasks" class="task-list"></ul>
            </div>
            <div id="in-progress-list" class="dropzone">
                <div class="box-title">任务进行中</div>
                <ul id="in-progress-tasks" class="task-list"></ul>
            </div>
            <div id="completed-list" class="dropzone">
                <div class="box-title">任务完成</div>
                <ul id="completed-tasks" class="task-list"></ul>
            </div>
        </div>

        <div class="controls">
            <div class="input-container">
                <input id="todo-title-input" type="text" placeholder="任务标题">
                <textarea id="todo-content-input" placeholder="任务内容"></textarea>
            </div>
            <div class="button-container">
                <button id="high-priority-button" class="high-priority-button">高优先级</button>
                <button id="add-button">添加任务</button>
                <button id="select-all-button">全选</button>
                <button id="clear-selected-button">清除选定</button>
                <button id="delete-button" class="delete-button">删除</button>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = 'https://us-west-2.aws.data.mongodb-api.com/app/data-dvxbygf/endpoint/data/v1';
        const apiKey = 'cdd60f67-ed14-4845-b280-a4d7f8b84b22';
        const todoTitleInput = document.getElementById('todo-title-input');
        const todoContentInput = document.getElementById('todo-content-input');
        const highPriorityButton = document.getElementById('high-priority-button');
        const addButton = document.getElementById('add-button');
        const selectAllButton = document.getElementById('select-all-button');
        const clearSelectedButton = document.getElementById('clear-selected-button');
        const todoList = document.querySelector('#todo-list .task-list');
        const inProgressList = document.querySelector('#in-progress-list .task-list');
        const completedList = document.querySelector('#completed-list .task-list');

        let todos = [];
        let highPriority = false;
        let draggedItem = null;

        highPriorityButton.addEventListener('click', () => {
            highPriority = !highPriority;
            highPriorityButton.style.backgroundColor = highPriority ? '#f44336' : '#4CAF50';
        });

        async function fetchTodos() {
            const response = await fetch(`${apiUrl}/action/find`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': apiKey,
                },
                body: JSON.stringify({
                    dataSource: 'Cluster0',
                    database: 'todoApp',
                    collection: 'todos'
                })
            });
            const data = await response.json();
            todos = data.documents;
            renderTodos();
        }

        async function saveTodos(todo) {
            await fetch(`${apiUrl}/action/insertOne`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': apiKey,
                },
                body: JSON.stringify({
                    dataSource: 'Cluster0',
                    database: 'todoApp',
                    collection: 'todos',
                    document: todo
                })
            });
            fetchTodos();
        }

        async function deleteTodo(id) {
            await fetch(`${apiUrl}/action/deleteOne`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': apiKey,
                },
                body: JSON.stringify({
                    dataSource: 'Cluster0',
                    database: 'todoApp',
                    collection: 'todos',
                    filter: { _id: { $oid: id } }
                })
            });
            fetchTodos();
        }

        function createTodoElement(todo) {
            const li = document.createElement('li');
            li.className = 'todo-item';
            li.draggable = true;
            li.dataset.id = todo._id.$oid;

            li.addEventListener('dragstart', () => {
                draggedItem = li;
                setTimeout(() => {
                    li.style.display = 'none';
                }, 0);
            });

            li.addEventListener('dragend', () => {
                setTimeout(() => {
                    draggedItem.style.display = 'block';
                    draggedItem = null;
                }, 0);
            });

            li.addEventListener('dragover', e => {
                e.preventDefault();
                if (li !== draggedItem) {
                    const allItems = Array.from(li.parentNode.querySelectorAll('.todo-item'));
                    const currentPos = allItems.indexOf(draggedItem);
                    const newPos = allItems.indexOf(li);

                    if (currentPos < newPos) {
                        li.parentNode.insertBefore(draggedItem, li.nextSibling);
                    } else {
                        li.parentNode.insertBefore(draggedItem, li);
                    }
                }
            });

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = todo.completed;
            checkbox.addEventListener('change', async () => {
                todo.completed = checkbox.checked;
                await saveTodos(todo);
            });

            const title = document.createElement('div');
            title.textContent = todo.title;
            title.className = 'todo-item-title';
            if (todo.priority === 'high') title.classList.add('high-priority');
            title.contentEditable = true;
            title.addEventListener('blur', async () => {
                todo.title = title.textContent;
                await saveTodos(todo);
            });

            const content = document.createElement('div');
            content.textContent = todo.content;
            content.className = 'todo-item-content';
            if (todo.completed) content.classList.add('completed');
            content.contentEditable = true;
            content.addEventListener('blur', async () => {
                todo.content = content.textContent;
                await saveTodos(todo);
            });

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.addEventListener('click', async () => {
                await deleteTodo(todo._id.$oid);
            });

            const highButton = document.createElement('button');
            highButton.textContent = '高优先级';
            highButton.addEventListener('click', async () => {
                todo.priority = todo.priority === 'high' ? 'normal' : 'high';
                await saveTodos(todo);
            });

            li.append(checkbox, title, content, highButton, deleteButton);

            return li;
        }

        function renderTodos() {
            todoList.innerHTML = '';
            inProgressList.innerHTML = '';
            completedList.innerHTML = '';

            todos.forEach(todo => {
                const todoElement = createTodoElement(todo);
                if (!todo.completed && !todo.inProgress) {
                    todoList.appendChild(todoElement);
                } else if (!todo.completed && todo.inProgress) {
                    inProgressList.appendChild(todoElement);
                } else {
                    completedList.appendChild(todoElement);
                }
            });
        }

        addButton.addEventListener('click', async () => {
            const title = todoTitleInput.value.trim();
            const content = todoContentInput.value.trim();

            if (title === '' || content === '') {
                alert('任务标题和内容不能为空');
                return;
            }

            const todo = {
                title,
                content,
                completed: false,
                priority: highPriority ? 'high' : 'normal',
                inProgress: false
            };

            await saveTodos(todo);
            todoTitleInput.value = '';
            todoContentInput.value = '';
            highPriority = false;
            highPriorityButton.style.backgroundColor = '';
            fetchTodos();
        });

        selectAllButton.addEventListener('click', async () => {
            todos.forEach(todo => {
                todo.completed = true;
            });
            await saveTodos(todos);
            fetchTodos();
        });

        clearSelectedButton.addEventListener('click', async () => {
            todos = todos.filter(todo => !todo.completed);
            await saveTodos(todos);
            fetchTodos();
        });

        document.querySelectorAll('.dropzone').forEach(dropzone => {
            dropzone.addEventListener('dragover', e => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#e0e0e0';
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.style.backgroundColor = '';
            });

            dropzone.addEventListener('drop', async e => {
                e.preventDefault();
                dropzone.style.backgroundColor = '';
                const id = draggedItem.dataset.id;
                const todo = todos.find(t => t._id.$oid === id);
                todo.inProgress = dropzone.id === 'in-progress-list';
                todo.completed = dropzone.id === 'completed-list';
                await saveTodos(todo);
                fetchTodos();
            });
        });

        fetchTodos();
    </script>
</body>
</html>
